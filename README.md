# espmake

espmake assists with managing multiple esphome project variants that share
yaml source files.  espmake also enables the sharing of pin definitions
and configuration definitions between yaml and C / C++ files by enabling
the use of C preprocessor directives inside esphome yaml files. See
lilymain.yaml, config.h and pins.h in the example directory.

espmake generates a new esphome.yaml file for each project variant.
project variants are found in the build/ directory. The variants are
named after the ESPMAKE_INIT variable setting.  For lily.yaml, the
esphome.yaml file will be found in build/lily. If the ESPMAKE_INIT
file is set to esphome.yaml, the build for it will be in build/esphome.

The reason a new esphome.yaml is generated is because espmake
runs the existing esphome project's yaml files through the
C-preprocessor (cpp) and leaves it there available for review - and
for esphome to process.

Once a yaml file is generated by the Makefile,  esphome commands
can be issued upon it, such as:
```bash
 esphome compile myProj_0.yaml
 esphome upload  myProj_0.yaml
 esphome logs    myProj_0.yaml
```
See 'esphome -h' for more details on esphome commands.  There are also
some convenience aliases that can be found in Bashrc.

## Installation

espmake is basically a Makefile in this directory which is manually copied
into an existing esphome project directory to enable the make command.
Note that this manual installation procedure assumes that the destination
project doesn't have a Makefile already. If it does, this Makefile could
be renamed and included from the project Makefile.  However that is left
as an exercise for the reader. To use it, activate the esphome venv
environment and then source the Bashrc, which will set ESPMAKE_HOME
and define the convenience aliases.

## Makefile User variables

These Makefile variables can be changed from their defaults by either
editting the Makefile or overriding them with an argument to make such as
```bash
make ESPMAKE_INIT=init.yaml
```
espmake will remember the ESPMAKE_INIT setting by storing it in
ESPMAKE_HOME/.espmake_project so that it does not have to be specified
afterwards.

### ESPMAKE_INIT

The initial/main yaml file that includes the others. it defaults
to "espinit.yaml".

## Generated files

Generated yaml can be deleted using 'make clean'. To remove the
binary build created by esphome, use 'make realclean'.

## Other

There are some additional comments describing Makefile features in the
Makefile.

There are some aliases in file Bashrc which may be helpful for issuing
esphome commands.  To dump the espmake config, try 'make print-config'.

espmake uses a small github project called cpptext
(https://github.com/maartenSXM/cpptext) to remove hash-style comments
before running files through the c-preprocessor.

cpptext leverages yq to merge multiple declaration of esphome sections
such as "sensor:" or "switch:".  This allows #ifdefs to declare them
in separate files conditionally and cpptext will merge them together for
processing by esphome.

# Credits

Thank you to Landon Rohatensky for the exemplary esphome yaml file
https://github.com/landonr/lilygo-tdisplays3-esphome used to demonstrate
espmake configuration, build and also as used in the test subdirectory.

Thank you Mike Farah for yq. It is at https://github.com/mikefarah/yq.

# Disclaimers

The author has not attempted to use espmake with Visual Studio.

# MacOS Note
Note: on MacOS, you need GNU sed to run dehash.sh, which espmake invokes.
To install GNU sed, please do this:
```
brew install gsed
```
and then add this line to your .bashrc:
```
export PATH="/opt/homebrew/opt/gnu-sed/libexec/gnubin:$PATH"
```
and then 'source .bashrc' or logout and log back in.

